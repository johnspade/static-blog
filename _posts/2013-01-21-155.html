---
layout: post
title: |-
  Парсинг XML на JavaScript
date: 2013-01-21 21:56:00
tags: 
  - софт
  - проекты
  - javascript
  - программирование
---

<div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-M7--CdcsKbk/UP1WkKnRMVI/AAAAAAAAFEk/-I_5nyruRgM/s1600/gdj.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="https://2.bp.blogspot.com/-M7--CdcsKbk/UP1WkKnRMVI/AAAAAAAAFEk/-I_5nyruRgM/s1600/gdj.png" /></a></div><br />Всем привет! Это продолжение статьи <a href="http://blog.johnspade.ru/posts/151">Пишем гаджет Windows 7</a>. Теперь мы напишем более сложный гаджет, чем просто кнопка для запуска игры. Он будет отображать текущую температуру на улице с четырех разных сайтов. Результат можно увидеть на скриншоте в начале статьи.<br /><br /><a name="more"></a><h3>Вступление</h3>На самом деле, я терпеть не могу всевозможные виджеты для отображения погоды. Они кажутся мне бесполезными, потому что узнавать погоду мне требуется слишком редко, и я для этого просто выхожу на балкон. Но я не собираюсь пользоваться собственным произведением, написал его чисто ради интереса. (Because we can).<br /><br />JavaScript - единственный из языков программирования, который оказался в программе первого семестра первого курса моей специальности в универе, так что мой гаджет работает именно на нем. Должен сказать, мне довольно нравится этот язык, потому что я люблю веб-дизайн и все с ним связанное, хоть и абсолютно не разбираюсь ни в джаваскрипте, ни в дизайне.<br /><br /><b><span style="color: red;">NB:</span></b> это не мануал, я просто рассказываю о том, как решил задачу, поставленную в первом абзаце статьи. Более того, прошу высказывать ваши замечания и более элегантные решения в комментариях.<br /><br />Брать температуру будем из XML-файлов, в которых погодные сайты отдают данные для разработчиков приложений. Это оказалось неожиданной проблемой - не так легко найти сайты, у которых можно скачать XML без регистрации бесплатно, я с трудом наскреб четыре штуки. Большинство для доступа к API требует оплату или регистрацию для получения индивидуального ключа доступа. Так что не удивляйтесь, что один из источников украинский :)<br /><br />Кстати, я прикрутил к блогу подсветку кода, сейчас ее и опробую. Здесь посты подобного рода публикуются сравнительно часто, так что без нее было немного неудобно. В старых записях пока все будет по-старому, как-нибудь потом допилю отображение кода и там.<br /><br /><h3>HTML</h3>Сначала напишем внешнее оформление гаджета, чтобы потом сразу привязать к нему javascript-код. Я создал четыре блока с двумя абзацами в каждом: для температуры и источника данных:<br /><pre>&lt;div id="container"&gt;<br /> &lt;div id="temp1"&gt;<br />  &lt;p id="digit1"&gt;&lt;/p&gt;<br />  &lt;p id="name1"&gt;Яндекс&lt;/p&gt;<br /> &lt;/div&gt;<br /> &lt;div id="temp2"&gt;<br />  &lt;p id="digit2"&gt;&lt;/p&gt;<br />  &lt;p id="name2"&gt;Yahoo&lt;/p&gt;<br /> &lt;/div&gt;<br /> &lt;div id="temp3"&gt;<br />  &lt;p id="digit3"&gt;&lt;/p&gt;<br />  &lt;p id="name3"&gt;Accuweather&lt;/p&gt;<br /> &lt;/div&gt;<br /> &lt;div id="temp4"&gt;<br />  &lt;p id="digit4"&gt;&lt;/p&gt;<br />  &lt;p id="name4"&gt;weather.co.ua&lt;/p&gt;<br /> &lt;/div&gt;<br />&lt;/div&gt;<br /></pre><br /><h3>CSS</h3>В файле CSS-стилей указываем размер и фон гаджета:<br /><pre>body { <br /> width: 260px;<br /> height: 180px;<br /> background-image: url("grass.jpg");<br />}<br /></pre>Вообще, указывать изображение для фона гаджета полагается с помощью специального элемента <code>g:image</code>, но у меня что-то не получилось.<br /><br />Я попытался расположить эти четыре блока в сетку с помощью <code>text-align: center</code> у родительского блока, в браузере это сработало, а в самом гаджете блоки все равно встали вертикально друг за другом. Тогда я разозлился и <strike>прибил их гвоздями</strike> указал для них абсолютную позицию в углах гаджета:<br /><pre>#temp1, #temp2, #temp3, #temp4 {<br /> position: absolute;<br /> width: 130px;<br /> height: 90px;<br /> margin: 0px;<br />}<br />#temp1 {<br /> top: 0px;<br /> left: 0px;<br />}<br />#temp2 {<br /> top: 0px;<br /> right: 0px;<br />}<br />#temp3 {<br /> bottom: 0px;<br /> left: 0px;<br />}<br />#temp4 {<br /> bottom: 0px;<br /> right: 0px;<br />}<br /></pre>Весь CSS-код показывать не буду, больше ничего важного там нет.<br /><br /><h3>JS</h3>Создаем .js-файлик и первым делом записываем в переменные источники данных:<br /><pre>var url1 = 'http://export.yandex.ru/weather-ng/forecasts/27612.xml';<br />var url2 = 'http://xml.weather.yahoo.com/forecastrss?p=RSXX0063&amp;u=c';<br />var url3 = 'http://rss.accuweather.com/rss/liveweather_rss.asp?metric=1&amp;locCode=ASI|RU|RS052|MOSCOW';<br />var url4 = 'http://xml.weather.co.ua/1.2/forecast/27?dayf=1';<br /></pre>По этим ссылкам - погода в Москве, для других городов нужно изменить коды в URL.<br /><br />Далее пишем функцию, которая будет загружать XML в переменную, используя ActiveX. Работать она будет только в Internet Explorer'е, но поддержка других браузеров нам не нужна, ибо гаджеты Windows работают именно через IE:<br /><pre>function loading(name, url) {<br /> if (window.ActiveXObject) { <br /> name = new ActiveXObject('Microsoft.XMLDOM');<br /> }<br /> name.async = false;<br /> name.load(url);<br /> return name;<br />}<br /></pre>Она проверяет, что браузер - IE, создает ActiveX-объект для XML и через метод <code>.load</code> загружает в него нужный файл. Вообще, обычно в подобных гаджетах это делают на jquery, но я написал все на чистом JS.<br /><br />Теперь садимся и смотрим на каждый XML-файл. У Яндекса текущая температура хранится в <code>fact → temperature</code>. Теги <code>&lt;temperature&gt;&lt;/temperature&gt;</code> встречаются несколько раз, но нужный нам стоит первым сверху. Это все, что нужно было узнать, теперь можно писать код:<br /><pre>temp1_xml = loading(xmlYa, url1);<br />temp1 = temp1_xml.getElementsByTagName('temperature')<br />[0].childNodes[0].nodeValue;<br />output1 = document.getElementById('digit1');<br />output1.innerHTML = temp1 + '°';<br /></pre>Здесь мы с помощью специального метода <code>.getElementsByTagName</code> собираем коллекцию элементов с тегом <code>temperature</code> и берем значение первого из них, которое выводим в подобающее место нашего гаджета, прибавляя значок градуса, чтобы цифры не смотрелись слишком абстрактно.<br /><br />В XML от Yahoo текущая температура хранится не в теге, а в атрибуте тега, вот так:<code>&nbsp;&lt;yweather:condition text="Light Snow" code="14" temp="-15" date="Mon, 21 Jan 2013 7:57 pm MSK"/&gt;</code>. Просто используем метод <code>.getAttribute</code>: <br /><pre>temp2_xml = loading(xmlYh, url2);<br />temp2 = temp2_xml.getElementsByTagName('yweather:condition')<br />[0].getAttribute('temp');<br />output2 = document.getElementById('digit2');<br />output2.innerHTML = temp2 + '°';<br /></pre>XML от accuweather.com оказался самым проблемным. Текущее состояние погоды хранится в первом сверху <code>item → title</code>, в строчке вида "Currently: Flurries: -13C". В зависимости от погоды второе слово может меняться, зато оба двоеточия будут всегда оставаться на месте (ну я надеюсь). Так что берем значение элемента как строку (метод <code>.data</code>) и обрезаем все до пробела после второго двоеточия, а также символ "C", он нам не нужен:<br /><pre>temp3_xml = loading(xmlAcw, url3);<br />var temp3_string = temp3_xml.getElementsByTagName('item')<br />[0].getElementsByTagName('title')[0].childNodes[0].data;<br />temp3 = temp3_string.substring<br />((temp3_string.lastIndexOf(': ')+2), (temp3_string.length-1));<br />output3 = document.getElementById('digit3');<br />output3.innerHTML = temp3 + '°';<br /></pre>Украинский сайт погоды сюрпризов не выдал, значение текущей температуры хранится в первом сверху теге <code>&lt;t&gt;</code>:<br /><pre>temp4_xml = loading(xmlUkr, url4);<br />temp4 = temp4_xml.getElementsByTagName('t')<br />[0].childNodes[0].nodeValue;<br />output4 = document.getElementById('digit4');<br />output4.innerHTML = temp4 + '°';<br /></pre>Осталось только сделать автообновление данных. Для этого я обернул весь вышеуказанный код вот так:<br /><pre>(function work() {<br />// весь код<br />setTimeout(work, 900000)<br />}) ();<br /></pre>Таким образом функция повторяет сама себя и данные обновляются каждые 15 минут. Где-то читал, что такой способ предпочтительнее, чем <code>setInterval</code>, а еще где-то вычитал, что оба этих метода в гаджетах Windows недопустимы, но ту статью я потерял :| Если есть лучший способ, прошу мне сообщить.<br /><br /><h3>Завершение</h3>Теперь можно собирать исходники в гаджет, об этом я рассказывал в <a href="http://blog.johnspade.ru/posts/151">предыдущей статье</a>. Не забудьте создать файл gadget.xml. Полный исходный код можно посмотреть, распаковав файл гаджета архиватором (ссылка в конце поста).<br /><br /><h3>Послесловие</h3>Вообще, в этой статье я хотел доделать гаджет из <a href="http://blog.johnspade.ru/posts/151">предыдущей</a> - выводить на кнопке количество часов, проведенных в игре. Я пытаюсь сделать это таким же способом - загрузка xml-данных своего профиля в Стиме методом <code>.load</code>, но в IE данные выводятся, а в гаджете - ни в какую. Я пока не разобрался, в чем проблема, так что ждите третьего поста на эту тему :) Задавайте вопросы в комментариях.<br /><br /><h3>Скачать</h3>Вы можете скачать то, что у меня получилось, если вам нужно:<br /><div class="separator" style="clear: both; text-align: center;"><a href="https://dl.dropbox.com/u/11765297/temperature.gadget" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="https://4.bp.blogspot.com/-EV7JoXhWrio/TQ3HDPLexMI/AAAAAAAAC0k/tercWQVGBaE/s1600/Download.png" /></a></div><br />