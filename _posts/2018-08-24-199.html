---
layout: post
title: |-
  Настройка AspectJ в приложении на Spring Boot и Kotlin
date: 2018-08-24 22:00:00
description: |-
  Настройка аннотации @Configurable и spring-aspects с помощью AspectJ в приложении на Spring Boot и Kotlin
tags:
  - программирование
---

<a href="/images/kotlina.jpg"><img class="img-responsive center-block" src="/images/kotlina.jpg" style="width: 300px;"/></a>
<p style="font-size: small; text-align: center;font-style: italic;">Маскот языка Kotlin – Котлина</p>
<p>Недавно прочитал книгу "Предметно-ориентированное проектирование" Эрика Эванса и загорелся его принципами. Она
    наконец позволила мне уложить в голове многие непонятные ранее вещи в программировании. У меня есть
    объектно-ориентированные языки программирования, фреймворки, схемы типа MVC, и надо с помощью этого как-то
    реализовать задачу или бизнес-процесс реального мира. Как это все использовать, с чего начать разрабатывать
    приложение, где писать бизнес-логику – в сервисах, контроллерах или где-то еще? Идея, что проектирование приложения
    надо начинать с классов-моделей предметной области, реализующих бизнес-логику и хранящих необходимые данные, дала
    мне ответы на эти вопросы. Сразу все стало понятно, как белый день – слоеная архитектура, MVC и все остальное. Когда
    модели предметной области на первом месте, все остальное будет на своем. Это далеко не все, чему нас учит DDD
    (domain-driven design), но с этого можно начать.</p>
<a name="more"></a>
<p>Я разрабатываю серверные приложения на языке Kotlin и фреймворке Spring Boot. Обычно в приложениях на нем сущности
    являются "анемичными", то есть служат только контейнерами для данных и не содержат бизнес-логики, которая
    располагается в сервисах-синглтонах. По правилам DDD бизнес-логика должна содержаться в моделях, а сервисы должны
    выполнять только логику, в которой участвуют несколько моделей, логику уровня приложения, а не отдельных моделей.
    Таким образом, сущности-модели должны иметь возможность обращаться к сервисам, то есть нужна возможность внедрения
    зависимостей (сервисов и других бинов) в объекты, не управляемые контекстом Spring'а.</p>
<p>Для этого Spring предлагает аннотацию <code>@Configurable</code>. Она позволяет фреймворку внедрять зависимости в
    объекты, создаваемые в приложении через оператор <code>new</code>.</p>
<p>Чтобы эта магия работала, в приложении должно быть настроено load-time weaving или compile-time weaving, то есть,
    применительно к аннотации <code>@Configurable</code>, перехват создания объектов и добавление к нему кода для
    внедрения зависимостей на этапе выполнения или компиляции. С этим мне пришлось повозиться в свое время, понять, чем
    одно отличается от другого, и как это все настроить.</p>
<p>Мне не очень нравится концепция LTW. Она усложняет запуск, вместе с jar-файлом приложения нужно еще поставлять
    jar-файл spring-instrument.jar и запускать сервер с параметром <code>-javaagent:spring-instrument.jar</code>.</p>
<p>Вот CTW другое дело, все необходимые действия производятся во время компиляции, сервер как обычно запускается через
    <code>java -jar ...</code> Для этого используется AspectJ, который запускает свой компилятор ajc для обработки
    java-файлов. Понятно, что для исходников на языке Kotlin это не сработает. К счастью, AspectJ также умеет работать с
    уже скомпилированными классами (слава байткод-совместимости Котлина и Джавы).</p>
<p>Для сборки приложений я использую Maven. Плагину aspectj-maven-plugin нужно указать параметр конфигурации <code>weaveDirectories</code>
    с путем к папке со скомпилированными классами. Соответственно, плагин должен быть запущен в фазе, когда классы уже
    скомпилированы. <a href="https://www.mojohaus.org/aspectj-maven-plugin/examples/weaveDirectories.html">Документация
        по параметру</a>.</p>
<p>Итак, для работы аннотации <code>@Configurable</code> в Spring Boot нужно проделать следующее:</p>
<ol>
    <li>Подключить Maven-плагин aspectj-maven-plugin в фазе <code>process-classes</code> или более поздней.</li>
    <li>Указать параметр конфигурации плагина <code>weaveDirectories</code> с путем к папке со скомпилированными
        классами.
    </li>
    <li>Указать параметр конфигурации плагина <code>aspectLibraries</code> с ссылкой на зависимость spring-aspects.</li>
    <li>Объявить аннотацию <code>@EnableSpringConfigured</code> на одном из классов конфигурации приложения.</li>
</ol>
<p>Таким образом можно настроить AspectJ-CTW в приложении на Spring и языке Kotlin, чтобы работала аннотация <code>@Configurable</code>.
    Я создал пример минимального проекта на Github, чтобы наглядно показать требуемые настройки для работы <code>@Configurable</code>
    и других аспектов Spring: <a href="https://github.com/johnspade/spring-boot-aspectj-kotlin-example">spring-boot-aspectj-kotlin-example</a>
</p>
<p>Советую прочитать книгу "Предметно-ориентированное проектирование", если еще не. Даже если она не перевернет ваш
    взгляд на программирование, это в любом случае очень крутая книга.</p>
