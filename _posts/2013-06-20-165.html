---
layout: post
title: |-
  Плагин Blue Screen of Kill для Sourcemod
date: 2013-06-20 18:41:00
tags: 
  - игры
  - проекты
  - программирование
---

<div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-a0MFw1jEQmA/UcL9PZHwBYI/AAAAAAAAFUg/9DXgJ8iVy8E/s1600/69580271.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="300" src="http://3.bp.blogspot.com/-a0MFw1jEQmA/UcL9PZHwBYI/AAAAAAAAFUg/9DXgJ8iVy8E/s400/69580271.jpg" width="400" /></a></div>В те времена, когда мне оставалось еще несколько лет до окончания школы, а мой компьютер не тянул Counter-Strike: Source, я играл в CS 1.6. На deathmatch-серверах мне очень нравился один плагин - при убийстве экран на секунду вспыхивал прозрачно-синим цветом. Он был популярным, многие сервера его использовали.<br /><br /><div>Потом я стал играть в CS:S и обнаружил, что ни на одном сервере такого плагина нет. Это было грустно, но пришлось смириться. Ну а недавно я запустил собственный сервер и подумал, что неплохо было бы иметь у себя такой плагин. Поиск по Гуглу ничего не дал - либо он слишком непопулярный среди игроков в CS:S, либо его еще никто не написал. Поэтому мной было решено написать этот плагин для Sourcemod самостоятельно.<br /><br /><a name='more'></a>Я боялся, что придется тыкаться в языке SourcePawn, как слепой котенок, но, к счастью, все необходимые функции были найдены в мануалах для начинающих. Начал я с&nbsp;<a href="http://wiki.alliedmods.net/Ru:Introduction_to_SourceMod_Plugins" target="_blank">Введения в написание Sourcemod-плагинов</a>, где рассказывается о структуре кода плагина и базовых командах, там же было обнаружено нужное мне <a href="http://wiki.alliedmods.net/Ru:Introduction_to_SourceMod_Plugins#.D0.A1.D0.BE.D0.B1.D1.8B.D1.82.D0.B8.D1.8F" target="_blank">событие для получения информации о смерти игрока</a>. С помощью <a href="https://twitter.com/justusebrain" target="_blank">Аквы</a> среди пользовательских сообщений была найдена <a href="http://wiki.alliedmods.net/User_Messages#Fade_Function" target="_blank">функция для затемнения экрана пользователя выбранным цветом</a>. Также она есть в библиотеке стоковых функций <a href="http://www.sourcemodplugins.org/smlib/" target="_blank">SMLIB</a>, в идеале можно просто ее подключить и прописать в коде только вызов с параметрами, но у меня ничего не получилось - компилятор кушать этот вызов отказался напрочь. Да и тащить целую библиотеку на сервер ради одной простенькой функции в одном плагине немного слишком.<br /><br />В общем, осталось только собрать все это дело вместе с параметрами.</div><pre>#include &lt;sourcemod&gt;<br /><br />public Plugin:myinfo = <br />{<br /> name = "Blue Screen of Kill",<br /> author = "johnspade",<br /> description = "The plugin fades the screen to transparent blue for a second when you kill someone",<br /> version = "1.0",<br /> url = "http://johnspade.ru"<br />}<br />// Получение события смерти<br />public OnPluginStart()<br />{<br /> HookEvent("player_death", Event_PlayerDeath);<br />}<br />// Функция затемнения<br />PerformFade(client, duration, const color[4]) {<br /> new Handle:hFadeClient=StartMessageOne("Fade",client)<br /> BfWriteShort(hFadeClient,duration)<br /> BfWriteShort(hFadeClient,0)<br /> BfWriteShort(hFadeClient,(0x0001))<br /> BfWriteByte(hFadeClient,color[0])<br /> BfWriteByte(hFadeClient,color[1])<br /> BfWriteByte(hFadeClient,color[2])<br /> BfWriteByte(hFadeClient,color[3])<br /> EndMessage()<br />}<br />// Получение игрока-убийцы, применение к нему функции затемнения<br />public Event_PlayerDeath(Handle:event, const String:name[], bool:dontBroadcast)<br />{<br /> new attacker_id = GetEventInt(event, "attacker");<br /> new attacker = GetClientOfUserId(attacker_id);<br /> PerformFade(attacker, 300, {0, 0, 200, 51});<br />// PerformFade(клиент, продолжительность, {красный, зеленый, синий, прозрачность})<br />}<br /></pre>Выглядит работа плагина так:<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-i_r4OTujo-M/UcMN1KdtN3I/AAAAAAAAFUw/MODxw9SIJok/s1600/hl2+2013-06-13+17-08-26-68.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="320" src="http://4.bp.blogspot.com/-i_r4OTujo-M/UcMN1KdtN3I/AAAAAAAAFUw/MODxw9SIJok/s400/hl2+2013-06-13+17-08-26-68.png" width="400" /></a></div><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-ujHwRD7jths/UcMN1AgQarI/AAAAAAAAFU0/jctrJx_TGso/s1600/hl2+2013-06-13+17-08-27-68.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="320" src="http://3.bp.blogspot.com/-ujHwRD7jths/UcMN1AgQarI/AAAAAAAAFU0/jctrJx_TGso/s400/hl2+2013-06-13+17-08-27-68.png" width="400" /></a></div>Увидеть эффект вживую можно на моем сервере. Для использования на своем сервере вы можете <a href="https://dl.dropboxusercontent.com/u/11765297/blue_screen_of_kill.smx">скачать готовый плагин</a> (положите его в папку&nbsp;cstrike\addons\sourcemod\plugins). Если вас не устраивает цвет, продолжительность или прозрачность вспышки, вы можете отредактировать параметры вызова функции самостоятельно (я указал их в последнем комментарии в коде) и скомпилировать код в <a href="http://www.sourcemod.net/compiler.php" target="_blank">онлайн-компиляторе</a>. Если что-то непонятно в коде, можно почитать статьи по ссылкам или задать вопрос в комментариях.